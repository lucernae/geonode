{% extends "geonode_base.html" %}
{% load bootstrap_tags %}
{% load staticfiles %}
{% load i18n %}
{% load leaflet_tags %}

{% block title %}
    {% trans "Leaflet" %} - {{ block.super }}
{% endblock title %}

{% block head %}
    {{ block.super }}
{% endblock head %}

{% block extra_head %}
    {{ block.super }}
    {% leaflet_css %}
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css" type="text/css"
          media="all"/>
    <link rel="stylesheet"
          href="https://cdn.rawgit.com/elesdoar/leaflet-control-orderlayers/master/dist/css/leaflet.control.orderlayers.min.css"
          type="text/css"/>
    <link rel="stylesheet" href="{% static 'lib/css/L.Control.Pan.css' %}"/>
    <link rel="stylesheet" href="{% static 'geonode/css/map_leaflet.css' %}"/>
    <style type="text/css">

        #layer-list .input-group{
            cursor: move;
        }

        .layer-item, .form-control.layer-item[disabled], label.form-control.layer-item {
            display: inline-block;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            cursor: move;
            vertical-align: middle;
        }

        label.form-control.layer-item.basemap-item{
            max-width: 200px;
            min-width: 200px;
            cursor: default;
        }

        .leaflet-left .easy-button-container{
            left: 23px;
        }

    </style>
{% endblock extra_head %}

{% block middle %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <div class="options-panel">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <label for="add_layer_select">{% trans "Available layers" %}</label>
                        </div>
                        <div class="panel-body">
                            <div class="input-group">
                                <select class="form-control" id="add_layer_select">
                                    <option>{% trans "Loading Layer Lists..." %}</option>
                                </select>
                                <span class="input-group-btn">
                                    <input id="add_layer_button" type="submit" class="btn btn-primary" value="{% trans "Add Layer" %}">
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <label>{% trans "Map layers" %}</label>
                        </div>
                        <div class="panel-body">
                            <div id="layer-list">
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <label>{% trans "Background layers" %}</label>
                        </div>
                        <div class="panel-body">
                            <div class="input-group">
                                <div id="background-layer-list">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="buttons">
                        <button class="btn btn-primary" data-toggle="modal" data-target="#save-map-modal">{% trans "Save" %}</button>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div id="map" style="position:relative; ">
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    {% block save_map_modal %}
    <div class="modal fade" id="save-map-modal" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">{% trans "Save Map" %}</h4>
                </div>
                <div class="modal-body">
                    <form role="form" id="save-map-form" action="{% url 'new_map_json' %}" method="post">
                        <div class="form-group">
                            <label for="map-title-input">{% trans "Title:" %}</label>
                            <input name="map-title" type="text" class="form-control" id="map-title-input"
                                   placeholder="Enter map title">
                        </div>
                        <div class="form-group">
                            <label for="map-abstract-input">{% trans "Abstract:" %}</label>
                            <textarea name="map-abstract" class="form-control" rows="5" id="map-abstract-input"
                                      placeholder="Enter map abstract"></textarea>
                        </div>
                        <div class="alert alert-info" id="info-message-modal" hidden>
                            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                            <span id="info-message-content">
                                <i class="fa fa-spinner fa-spin"></i>{% trans "Saving in progress. Please wait." %}
                            </span>
                        </div>
                        <div class="alert alert-success" id="success-message-modal" hidden>
                            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                            <span id="success-message-content">
                                {% trans "Map Successfully Saved." %}
                            </span>
                            <div>
                                <a id="go-to-map" class="btn btn-primary" href="#">{% trans "Go To Map Detail" %}</a>
                                <a class="btn btn-default" href="{% url "maps_browse" %}">{% trans "Go To Map List" %}</a>
                            </div>
                        </div>
                        <div class="alert alert-danger" id="error-message-modal" hidden>
                            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                            <span id="error-message-content"></span>
                        </div>
                        <button type="submit" class="btn btn-default">{% trans "Save" %}</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Close" %}</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endblock save_map_modal %}
{% endblock middle %}

{% block footer %}
    {{ block.super }}
{% endblock footer %}

{% block extra_script %}
{{ block.super }}
    {% leaflet_js %}
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"
            type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.4.2/Sortable.min.js"></script>
    <script src="https://cdn.rawgit.com/elesdoar/leaflet-control-orderlayers/master/dist/leaflet.control.orderlayers.min.js"></script>
    <script src="https://cdn.rawgit.com/elesdoar/leaflet-control-orderlayers/master/dist/leaflet.control.orderlayers.min.js"></script>

    <script src="{% static 'lib/js/L.Control.Pan.js' %}"></script>

    <script type="text/javascript">
        jQuery.fn.extend({
            propAttr: $.fn.prop || $.fn.attr
        });
        var map = $("#map");
        var active_background_layer;

        var all_layers = {};
        var all_layers_list = [];

        // Define some default base layers
        var osm = L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        });

        var OpenMapSurfer_Roads = L.tileLayer('https://korona.geog.uni-heidelberg.de/tiles/roads/x={x}&y={y}&z={z}', {
            maxZoom: 20,
            attribution: 'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });

        {% if create %}
            {# if new map, define default basemaps#}
            all_layers = {
                'OpenMapSurfer_Roads': {
                    'title': 'OpenMapSurfer Roads',
                    'name': 'OpenMapSurfer_Roads',
                    'alternate': 'OpenMapSurfer_Roads',
                    'url': OpenMapSurfer_Roads._url,
                    'layer': OpenMapSurfer_Roads,
                    'visibility': false,
                    'group': 'background',
                    'attribution': '',
                    'zIndex': 0
                },
                'OpenStreetMap': {
                    'title': 'OpenStreetMap',
                    'name': 'OpenStreetMap',
                    'alternate': 'OpenMapSurfer_Roads',
                    'url': osm._url,
                    'layer': osm,
                    'visibility': true,
                    'group': 'background',
                    'attribution': '',
                    'zIndex': 0
                }
            };
        {% else %}
            {# If not create mode, initialize empty and register from map layers. #}
            all_layers = {};
        {% endif %}

        function _register_to_layer_list(layer_desc) {
            var layer_name = layer_desc['alternate'];
            var leaflet_layer_obj = L.tileLayer(layer_desc['url'], {
                attribution: layer_desc['attribution']
            });
            layer_desc['layer'] = leaflet_layer_obj;
            all_layers[layer_name] = layer_desc;
        }

        function _register_to_layer_select_list(layer_desc, option_index){
            var $add_layer_select = $("#add_layer_select");
            var $option = $(`<option value="${layer_desc.name}"
                id="option_${layer_desc.name}"
                data-value="${layer_desc.name}"
                data-layer-alternate="${layer_desc.alternate}">${layer_desc.title}</option>`);
            if(option_index){
                $add_layer_select.find(`option:eq(${option_index})`).before($option);
            } else {
                $add_layer_select.append($option);
            }
        }

        {# Extra basemap tiles from LEAFLET_CONFIG #}
        var extra_basemaps = [
        {% if LEAFLET_CONFIG and LEAFLET_CONFIG.TILES %}
            {% for tile in LEAFLET_CONFIG.TILES %}
                {
                    'title': "{{ tile.0 }}",
                    'name': "{{ tile.0 }}",
                    'alternate': "{{ tile.0 }}",
                    'url': '{{ tile.1|safe }}',
                    'visibility': false,
                    'group': 'background',
                    'attribution': '{{ tile.2|safe }}',
                    'zIndex': 0
                }{% if not forloop.last %},{% endif %}

            {% endfor %}
        {% endif %}
        ];

        for(var i=0;i<extra_basemaps.length;i++){
            _register_to_layer_list(extra_basemaps[i]);
        }

        {# fetch layers list from api #}
        {% block layer_fetch_script %}
        $.getJSON('{% url "api_api_top_level" api_name="api" %}layers',  function(data){
            if(data === undefined || data.objects === undefined){
                return
            }
            var $add_layer_select = $("#add_layer_select");
            var objects = data['objects'];
            var layer;
            $add_layer_select.empty();
            for(var i=0;i<objects.length;i++){
                layer = objects[i];
                _register_to_layer_list(layer);
                layer.option_index = i;
                layer.group = '';
                _register_to_layer_select_list(layer);
            }

            // Populate radio button for background layer
            populate_background_layer(all_layers_list, all_layers);
            init_data_script();
        });
        {% endblock layer_fetch_script %}

        {% block init_script %}
            {# This function gets called when layer's list are finally fetched. #}
            function init_data_script(){
            {% if copy or not create %}
                {# Create new map from copying existing map. Or update existing map. #}
                $.getJSON('{% url "api_api_top_level" api_name="api" %}maps/{{ map.id }}',  function(data){
                    if(data === undefined || data.layers === undefined){
                        return
                    }
                    var map_obj = data;
                    var layers = data.layers;
                    var last_promise;
                    for(var i=0;i<layers.length;i++){
                        {# ignore background layers #}
                        var layer = layers[i];
                        var layer_name = layer.name;
                        if(layer.group === 'background'){
                            if(layer.visibility === true){
                                {# remove current basemap #}
                                map.removeLayer(active_background_layer.layer);
                                remove_from_list(all_layers_list, active_background_layer.name);

                                {# set new basemap #}
                                active_background_layer = all_layers[layer_name];
                                active_background_layer.visibility = true;
                                active_background_layer.layer.addTo(map);
                                active_background_layer.layer.setZIndex(0);
                                all_layers_list.push(active_background_layer.name);
                                populate_background_layer(all_layers_list, all_layers);
                            }

                            continue
                        }
                        var layer_desc = all_layers[layer_name];
                        layer_desc['url'] = layer_desc.ows_url;
                        layer_desc['zIndex'] = layer_desc.stack_order;

                        {# synchronously add layer in series #}
                        if(last_promise === undefined) {
                            last_promise = $.when(
                                add_layer(layer_desc.alternate, layer_desc.visibility, layer_desc.stack_order));
                        }
                        else {
                            last_promise.done(function(){
                                last_promise = $.when(
                                    add_layer(layer_desc.alternate, layer_desc.visibility, layer_desc.stack_order));
                            });
                        }
                    }

                    if(last_promise !== undefined){
                        last_promise.done(function(){
                            zoom_to_box(map, [map_obj.bbox_x0, map_obj.bbox_y0, map_obj.bbox_x1, map_obj.bbox_y1]);
                        });
                    }
                });
            {% elif create and not copy %}
                {# Create new map from including existing layer #}
                {# Check layer parameter in url#}
                var url = new URL(window.location);
                var params = new URLSearchParams(url.search);
                var layers = params.getAll('layer');
                for(var i=0;i<layers.length;i++){
                    var layer=layers[i];
                    add_layer(layer);
                }
            {% endif %}
            }
        {% endblock init_script %}

        var w_height = $(window).height();
        var map_height = w_height - $('nav').height();
        map.css("height", map_height);

        function remove(id) {
            return (elem = document.getElementById(id)).parentNode.removeChild(elem);
        }

        function zoom_to_box(map, bbox) {
            {# each point is on lat long format #}
            {# bbox is in the form x0,y0,x1,y1 #}
            var bounds = [
                [bbox[1], bbox[0]],
                [bbox[3], bbox[2]]
            ];
            map.fitBounds(bounds);
        }

        function check_box_layer_clicked(check_box) {
            if (check_box.checked) {
                map.addLayer(all_layers[check_box.value].layer);
                all_layers[check_box.value].visibility = true;
            } else {
                if (map.hasLayer(all_layers[check_box.value].layer)) {
                    map.removeLayer(all_layers[check_box.value].layer);
                    all_layers[check_box.value].visibility = false;
                }
            }
        }

        function delete_layer_clicked(button) {
            // Remove layer from the map
            var layer_desc = all_layers[button.value];
            if (map.hasLayer(layer_desc.layer)) {
                map.removeLayer(layer_desc.layer);
            }
            // Remove layer from map layer list
            remove(`ig_${button.value}`);
            // Remove from list overlay layers
            remove_from_list(all_layers_list, button.value);

            // Show from available layer
            _register_to_layer_select_list(layer_desc, layer_desc.option_index);
        }

        function remove_from_list(list, item) {
            var item_index = list.indexOf(item);
            if (item_index > -1) {
                list.splice(item_index, 1)
            }
        }

        function compare_bounds(bound1, bound2) {
            {# Bound in the format x0,y0,x1,y1 #}
            return [
                Math.min(bound1[0], bound2[0], bound1[2], bound2[2]),
                Math.min(bound1[1], bound2[1], bound1[3], bound2[3]),
                Math.max(bound1[0], bound2[0], bound1[2], bound2[2]),
                Math.max(bound1[1], bound2[1], bound1[3], bound2[3])]
        }

        function add_layer(layer_typename, visibility, layer_order) {
            visibility = typeof visibility !== 'undefined' ? visibility : true;
            if (!layer_typename) {
                return
            }
            return $.ajax({
                type: 'GET',
                url: '{% url 'qgis_server:get_layer' layername="layer_typename" %}'.replace('layer_typename', layer_typename),
                data: {},
                dataType: 'json',
                success: function (json) {
                    var layer_url = json.url;
                    var layer_title = json.title;
                    var layer_name = layer_typename;

                    // Add layer to leaflet
                    var tile_layer = L.tileLayer(layer_url);
                    if (tile_layer != null) {
                        // Set view to new added layer
                        var bounds = [json.bbox_x0, json.bbox_y0,
                            json.bbox_x1, json.bbox_y1];

                        // Determine which extent should be used, only uses the widest one
                        var temp_bounds = bounds;
                        for(var i=0;i<all_layers_list.length;i++){
                            var layer = all_layers[all_layers_list[i]];
                            if(layer.bounds !== undefined){
                                temp_bounds = compare_bounds(temp_bounds, layer.bounds);
                            }
                        }
                        bounds = temp_bounds;
                        zoom_to_box(map, bounds);

                        // Add to list layer
                        var $layer_ig = $(`<span class='input-group' id='ig_${layer_name}'>
                            <span class='input-group-addon'>
                                <span class='glyphicon glyphicon-move'></span>
                            </span>
                            <span class='input-group-addon'>
                                <input class='layer-item-checkbox' type='checkbox' onclick='check_box_layer_clicked(this);' name='show_layer' value='${layer_name}'>
                            </span>
                            <input type="text" class='form-control layer-item' readonly disabled value='${layer_title}'  data-value='${layer_name}'/>
                            <span class='input-group-btn'>
                                <button type='button' class='btn btn-danger' onclick='delete_layer_clicked(this);' value='${layer_name}'>X</button>
                            </span>
                            </li>`);

                        if (visibility) {
                            // Add the layer
                            map.addLayer(tile_layer);
                            $layer_ig.find('input.layer-item-checkbox').prop('checked', true);
                        }

                        $("#layer-list").prepend($layer_ig);

                        // Add to memory
                        var added_layer = all_layers[layer_name];
                        added_layer.title = layer_title;
                        added_layer.alternate = json.alternate;
                        added_layer.url = layer_url;
                        added_layer.layer = tile_layer;
                        added_layer.bounds = bounds;
                        added_layer.visibility = visibility;
                        if (layer_order) {
                            added_layer.zIndex = layer_order;
                        } else {
                            added_layer.zIndex = all_layers_list.length;
                        }
                        all_layers[layer_name] = added_layer;

                        // Add to list of overlay layers
                        all_layers_list.push(layer_name);

                        // Set zIndex of the layer
                        tile_layer.setZIndex(added_layer.zIndex);


                        // Hide from available layer
                        $(`#add_layer_select > option[data-layer-alternate="${layer_name}"]`).remove();
                        $('#add_layer_select').prop('selectedIndex', -1);
                    }
                },
                error: function (xhr, errmsg, err) {
                    console.log(xhr.status + ": " + xhr.responseText);
                }
            });
        }

        function save_map(event) {
            event.preventDefault();
            var $info_modal = $("#info-message-modal");
            var $error_modal = $("#error-message-modal");
            var $success_modal = $("#success-message-modal");

            $info_modal.show();
            var form_data = $('#save-map-form').serializeObject();

            // Collect layers
            var layers = [];
            var map_data = {};

            map_data['sources'] = {};
            for (i = 0; i < all_layers_list.length; i++) {
                var key = all_layers_list[i];
                var layer_desc = all_layers[key];
                var source_token = 'source_' + layer_desc.name;
                layers.push(
                        {
                            'name': layer_desc.alternate,
                            'title': layer_desc.title,
                            'visibility': layer_desc.visibility,
                            'url': layer_desc.url,
                            'group': layer_desc.group,
                            'source': source_token
                        }
                );
                map_data['sources'][source_token] = {
                    'url': layer_desc.url
                };
            }

            map_data['about'] = {
                'title': form_data['map-title'],
                'abstract': form_data['map-abstract']
            };
            {# GeoNode Map backend json post handler uses EPSG:3857 for the 'center' key #}
            {# It however uses projection EPSG:4326 for the bbox, so we update accordingly #}
            var center_point = L.Projection.Mercator.project(map.getCenter());
            map_data['map'] = {
                {# In EPSG:3857 #}
                'center': [center_point.x, center_point.y],
                'zoom': map.getZoom(),
                {# In EPSG:4326 #}
                'projection': 'EPSG:4326',
                'layers': layers
            };

            $.ajax({
                url: $(this).attr('action'),
                type: $(this).attr('method'),
                data: JSON.stringify(map_data),
                cache: false,
                processData: false,
                contentType: false,
                dataType: 'json',
                success: function (data) {
                    if(data === undefined || data.errors){
                        $("#error-message-content").html(
                            `{% trans "<strong>Failed!</strong> There is an error when saving the map. <br/><div class='panel panel-default'>${data.errors}</div>" %}`);
                        $error_modal.show();
                    }
                    if(data){
                        var detail_url = '{% url "map_detail" mapid=1 %}'.replace('1', data.id);
                        $("#go-to-map").attr('href', detail_url);
                        $success_modal.show();
                    }
                    $info_modal.hide();
                },
                error: function (xhr, status, error) {
                    $error_modal.html(
                            `{% trans "<strong>Failed!</strong> There is an error when saving the map. <br/><div class='panel panel-default'>${error}</div>" %}`);
                    $error_modal.show();
                }
            });
        }

        function populate_background_layer(the_list, the_dict) {
            var $background_layer_list = $("#background-layer-list");
            $background_layer_list.empty();
            for(var key in the_dict){
                var background_layer = the_dict[key];
                if (background_layer.group !== 'background') {
                    continue;
                }
                if(active_background_layer._url === background_layer.url){
                    background_layer.visibility = true
                }
                var $background_input_dom = $(
                    `<span class='input-group'>
                        <span class='input-group-addon'>
                            <input id='basemap_radio_${key}' type="radio" name="background-layer" value="${key}">
                        </span>
                        <label for='basemap_radio_${key}' class='form-control layer-item basemap-item'>${background_layer.title}</label>
                    </span>`);
                if (background_layer.visibility === "True" || background_layer.visibility === true) {
                    active_background_layer = background_layer;
                    $background_input_dom.find('input').prop('checked', true);

                }
                $background_layer_list.append($background_input_dom);

            }
            // Add radio button listener for background layer
            $('input:radio[name=background-layer]').change(function () {
                var new_background_layer = the_dict[this.value];
                {# remove from layer list  #}
                remove_from_list(the_list, active_background_layer.name);
                map.removeLayer(active_background_layer.layer);

                new_background_layer.layer.addTo(map);
                new_background_layer.layer.setZIndex(0);
                new_background_layer.visibility = true;
                active_background_layer = new_background_layer;
                {# Always insert basemap at lowest order #}
                the_list.splice(0, 0, new_background_layer.name);
            });
        }

        $(document).ready(function () {

            // Initiate map

            active_background_layer = all_layers['OpenStreetMap'];
            active_background_layer.visibility = true;
            all_layers_list.push(active_background_layer.name);

            map = L.map('map', {
                center: [-6.2, 106.8],
                zoom: 11,
                layers: [active_background_layer.layer]
            });

            L.easyButton({
                states: [{
                    stateName: 'zoom-all',
                    icon: 'fa-globe',
                    title: '{% trans "Zoom to global view" %}',
                    zIndex: 1,
                    onClick: function (control) {
                        zoom_to_box(map, [0, 90, 0, -90]);
                        map.setZoom(2);
                    }
                    }]
            }).addTo(map);

            // Make sortable
            var list = document.getElementById("layer-list");
            Sortable.create(list, {
                onEnd: function (/**Event*/evt) {
                    if (evt.newIndex == undefined) {
                        // Move but to the same location.
                        return;
                    }
                    var num_background = 0;

                    for (i = 0; i < all_layers_list.length; i++) {
                        if (all_layers[all_layers_list[i]].group == 'background') {
                            num_background++;
                        }
                    }
                    var num_overlay = all_layers_list.length - num_background;

                    var layer_list = $("#layer-list .layer-item");
                    function zIndex(item_index){
                        {# zIndex 0 is preserved for basemap #}
                        var offset = 1;
                        {# higher zIndex means top of the layer #}
                        {# lower item index means top of the stack #}
                        return offset + num_overlay - item_index + 1;
                    }

                    layer_list.each(function(index, val){
                        var layer_typename = $(val).attr('data-value');
                        var layer = all_layers[layer_typename].layer;
                        layer.setZIndex(zIndex(index));
                    });

                }
            }); // That's all

        });

        $("#add_layer_button").click(function () {
            // Get value from select option
            var add_layer_select = $("#add_layer_select option:selected");
            var layer_typename = add_layer_select.attr('data-layer-alternate');

            add_layer(layer_typename);

        });

        $('#save-map-form').submit(save_map);
    </script>
{% endblock extra_script %}
